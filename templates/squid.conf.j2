acl public src all # Anywhere

acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443

# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost
http_access allow localhost manager
http_access deny manager

http_access allow public
http_access deny to_localhost
http_access deny to_linklocal
# And finally deny all other access to this proxy
http_access deny all

http_port 8080


# Size is in MB
cache_dir aufs /var/spool/squid {{ (((squid_volume_size|int * 80) // 100) * 1024) }} 16 256

maximum_object_size {{ squid_max_object_size_mb }} MB

cache_mem {{ (ansible_memtotal_mb|int * 80) // 100 }} MB
maximum_object_size_in_memory {{ squid_max_object_size_mb_in_mem }} MB

# Leave coredumps in the first cache dir
coredump_dir /var/spool/squid

refresh_pattern -i (/cgi-bin/|\?) 0	0%	0

### DEBIAN REFRESH PATTERNS
# refresh pattern for debs and udebs
refresh_pattern deb$   129600 100% 129600
refresh_pattern udeb$   129600 100% 129600
refresh_pattern tar\.gz$  129600 100% 129600
refresh_pattern tar\.xz$  129600 100% 129600
refresh_pattern tar\.bz2$  129600 100% 129600

# always refresh Packages and Release files
refresh_pattern \/(Packages|Sources)(|\.bz2|\.gz|\.xz)$ 0 0% 0 refresh-ims
refresh_pattern \/Release(|\.gpg)$ 0 0% 0 refresh-ims
refresh_pattern \/InRelease$ 0 0% 0 refresh-ims
refresh_pattern \/(Translation-.*)(|\.bz2|\.gz|\.xz)$ 0 0% 0 refresh-ims

# handle meta-release and changelogs.ubuntu.com special
# (fine to have this on debian too)
refresh_pattern changelogs.ubuntu.com\/.*  0  1% 1

